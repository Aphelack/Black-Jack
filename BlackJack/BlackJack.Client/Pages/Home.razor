@page "/"
@using BlackJack.Client.Services
@using BlackJack.Shared.Models
@using System.Linq
@inject GameClientService GameService
@implements IAsyncDisposable

<PageTitle>Black Jack</PageTitle>

<div class="main-container">
    <h1>Black Jack</h1>

    @if (!_isConnected)
    {
        <p>Connecting to server...</p>
    }
    else if (_gameState == null)
    {
        <div class="setup">
            <div class="mb-3">
                <label>Your Name:</label>
                <input @bind="_playerName" class="form-control" />
            </div>
            <div class="mb-3">
                <label>Room Name (Optional):</label>
                <input @bind="_roomName" class="form-control" />
            </div>
            <button class="btn btn-primary" @onclick="CreateGame">Create Game</button>
            
            <div class="mt-3">
                <label>Game ID to Join:</label>
                <input @bind="_gameIdToJoin" class="form-control" />
                <button class="btn btn-secondary" @onclick="JoinGame">Join Game</button>
            </div>
        </div>
    }
    else
    {
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>@(_gameState.RoomName ?? "Game Room")</h2>
            <button class="btn btn-danger btn-sm" @onclick="LeaveGame">Leave Room</button>
        </div>

        <GameBoard GameState="_gameState" CurrentPlayerConnectionId="@GameService.ConnectionId" />

        @if (_gameState.Status == GameStatus.WaitingForPlayers)
        {
            <div class="info-panel">
                <p>Waiting for players to join... Share Game ID: <strong>@_gameState.GameId</strong></p>
                <div class="mb-3">
                    <h4>Players:</h4>
                    @foreach (var player in _gameState.Players.Where(p => !p.IsDealer))
                    {
                        <div class="player-status">
                            <span>@player.Name</span>
                            @if (player.IsReady)
                            {
                                <span class="badge bg-success">Ready</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">Not Ready</span>
                            }
                        </div>
                    }
                </div>
                @if (CurrentPlayer != null)
                {
                    <button class="btn @(CurrentPlayer.IsReady ? "btn-warning" : "btn-success")" @onclick="ToggleReady">
                        @(CurrentPlayer.IsReady ? "Not Ready" : "Ready")
                    </button>
                }
            </div>
        }
        else if (_gameState.Status == GameStatus.InProgress)
        {
            <div class="actions">
                <button class="btn btn-primary" @onclick="Hit" disabled="@(!IsMyTurn || (CurrentPlayer?.IsBusted ?? false))">Hit</button>
                <button class="btn btn-warning" @onclick="Stand" disabled="@(!IsMyTurn)">Stand</button>
            </div>
        }
        else if (_gameState.Status == GameStatus.Finished)
        {
            <div class="actions">
                <button class="btn btn-success" @onclick="RestartGame">Play Again</button>
                <button class="btn btn-primary" @onclick="Reset">Back to Menu</button>
            </div>
        }
    }

    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <div class="alert alert-danger mt-3">@_errorMessage</div>
    }
</div>

<style>
    .main-container {
        background-image: url('Hub/gameHubBackground.jpg');
        background-size: cover;
        min-height: 100vh;
        padding: 20px;
        color: white;
        background-color: #FFE4E1;
    }
    .setup, .actions, .info-panel, h1, p {
        background-color: rgba(255, 20, 147, 0.8);
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 10px;
        border: 2px solid #FF69B4;
        box-shadow: 0 4px 8px rgba(255, 105, 180, 0.3);
    }
    .setup {
        max-width: 400px;
    }
    .player-status {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px;
        margin: 5px 0;
        background-color: rgba(255, 182, 193, 0.3);
        border-radius: 5px;
        border: 1px solid #FF69B4;
    }
    .btn-success {
        background-color: #FF69B4;
        border-color: #FF1493;
    }
    .btn-success:hover {
        background-color: #FF1493;
        border-color: #C71585;
    }
    .btn-warning {
        background-color: #FFB6C1;
        border-color: #FF69B4;
        color: #8B008B;
    }
    .btn-warning:hover {
        background-color: #FF69B4;
        border-color: #FF1493;
    }
    .btn-danger {
        background-color: #DC143C;
        border-color: #C71585;
    }
    .btn-danger:hover {
        background-color: #C71585;
        border-color: #8B008B;
    }
    .btn-secondary {
        background-color: #DB7093;
        border-color: #FF69B4;
        color: white;
    }
    .btn-secondary:hover {
        background-color: #FF69B4;
        border-color: #FF1493;
    }
    .badge.bg-success {
        background-color: #FF69B4 !important;
    }
    .badge.bg-secondary {
        background-color: #DB7093 !important;
    }
    .alert-danger {
        background-color: #FFB6C1;
        border-color: #FF1493;
        color: #8B008B;
    }
</style>

@code {
    private string _playerName = "Player";
    private string _roomName;
    private string _gameIdToJoin;
    private GameState _gameState;
    private bool _isConnected;
    private string _errorMessage;
    
    private bool IsMyTurn => _gameState?.CurrentTurnConnectionId == GameService.ConnectionId;
    private Player CurrentPlayer => _gameState?.Players.FirstOrDefault(p => p.ConnectionId == GameService.ConnectionId);
    
    protected override async Task OnInitializedAsync()
    {
        GameService.OnGameUpdated += HandleGameUpdate;
        GameService.OnGameCreated += HandleGameCreated;
        GameService.OnError += HandleError;
        
        await GameService.InitializeAsync();
        _isConnected = true;
    }

    private void HandleGameUpdate(GameState state)
    {
        _gameState = state;
        _errorMessage = null;
        StateHasChanged();
    }

    private void HandleGameCreated(string gameId)
    {
        // We are already in the group and will receive update
    }

    private void HandleError(string message)
    {
        _errorMessage = message;
        StateHasChanged();
    }

    private async Task CreateGame()
    {
        if (string.IsNullOrWhiteSpace(_playerName)) return;
        await GameService.CreateGame(_playerName, _roomName);
    }

    private async Task JoinGame()
    {
        if (string.IsNullOrWhiteSpace(_playerName) || string.IsNullOrWhiteSpace(_gameIdToJoin)) return;
        await GameService.JoinGame(_gameIdToJoin, _playerName);
    }

    private async Task LeaveGame()
    {
        if (_gameState == null) return;
        await GameService.LeaveGame(_gameState.GameId);
        _gameState = null;
    }

    private async Task RestartGame()
    {
        if (_gameState == null) return;
        await GameService.RestartGame(_gameState.GameId);
    }

    private async Task ToggleReady()
    {
        if (_gameState == null) return;
        await GameService.SetReady(_gameState.GameId);
    }

    private async Task Hit()
    {
        if (_gameState == null) return;
        await GameService.Hit(_gameState.GameId);
    }

    private async Task Stand()
    {
        if (_gameState == null) return;
        await GameService.Stand(_gameState.GameId);
    }

    private void Reset()
    {
        _gameState = null;
        _errorMessage = null;
    }

    public async ValueTask DisposeAsync()
    {
        GameService.OnGameUpdated -= HandleGameUpdate;
        GameService.OnGameCreated -= HandleGameCreated;
        GameService.OnError -= HandleError;
        await GameService.DisposeAsync();
    }
}
